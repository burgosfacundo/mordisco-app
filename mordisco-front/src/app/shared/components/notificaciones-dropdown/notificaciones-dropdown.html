<button 
  [matMenuTriggerFor]="notifMenu"
  class="relative p-2 rounded-full hover:bg-white/20 transition-colors">
  <mat-icon 
    [matBadge]="noLeidas()" 
    [matBadgeHidden]="noLeidas() === 0"
    matBadgeColor="warn"
    matBadgeSize="small"
    class="text-white">
    notifications
  </mat-icon>
  
  <!-- Indicador de conexión -->
  @if (conectado()) {
    <span class="absolute bottom-0 right-0 w-3 h-3 bg-green-500 border-2 border-white rounded-full"></span>
  }
</button>

<mat-menu #notifMenu="matMenu" xPosition="before" class="notif-menu">
  <!-- Header -->
  <div class="px-4 py-3 border-b border-gray-200 bg-gray-50" (click)="$event.stopPropagation()">
    <div class="flex items-center justify-between mb-2">
      <h3 class="font-bold text-gray-900">Notificaciones</h3>
      @if (noLeidas() > 0) {
        <button 
          (click)="marcarTodasLeidas()"
          class="text-xs text-primary-600 hover:text-primary-700 font-semibold transition-colors">
          Marcar todas como leídas
        </button>
      }
    </div>
    
    <!-- Estado de conexión -->
    <div class="flex items-center gap-2 text-xs">
      @if (conectado()) {
        <span class="flex items-center gap-1 text-green-600">
          <span class="w-2 h-2 bg-green-600 rounded-full animate-pulse"></span>
          Conectado
        </span>
      } @else {
        <span class="flex items-center gap-1 text-red-600">
          <span class="w-2 h-2 bg-red-600 rounded-full"></span>
          Desconectado
        </span>
      }
    </div>
  </div>

  <!-- Lista de notificaciones -->
  @if (hayNotificaciones()) {
    <div class="max-h-96 overflow-y-auto">
      @for (notif of notificaciones(); track $index) {
        <button 
          mat-menu-item 
          (click)="irAPedido(notif.pedidoId, $index)"
          [class.bg-primary-50]="!notif.leida"
          class="w-full px-4 py-3 hover:bg-gray-50 transition-colors border-b border-gray-100 last:border-0">
          <div class="flex items-start gap-3 w-full">
            <!-- Ícono -->
            <div class="shrink-0 mt-1">
              <mat-icon [class]="getColorPorTipo(notif.tipo)">
                {{ getIconoPorTipo(notif.tipo) }}
              </mat-icon>
            </div>
            
            <!-- Contenido -->
            <div class="flex-1 min-w-0 text-left">
              <p class="text-sm font-semibold text-gray-900 mb-1">
                {{ notif.mensaje }}
              </p>
              <div class="flex items-center gap-2">
                <p class="text-xs text-gray-500">
                  {{ notif.timestamp | date:'dd/MM/yyyy HH:mm' }}
                </p>
                @if (notif.estado) {
                  <span class="text-xs px-2 py-0.5 rounded-full bg-gray-100 text-gray-700">
                    {{ notif.estado }}
                  </span>
                }
              </div>
            </div>
            
            <!-- Indicador de no leída -->
            @if (!notif.leida) {
              <div class="shrink-0">
                <div class="w-2 h-2 rounded-full bg-primary-600"></div>
              </div>
            }
          </div>
        </button>
      }
    </div>
    
    <!-- Footer -->
    <div class="px-4 py-2 border-t border-gray-200 bg-gray-50" (click)="$event.stopPropagation()">
      <button 
        (click)="limpiarTodas()"
        class="text-xs text-red-600 hover:text-red-700 font-semibold w-full text-center transition-colors">
        Limpiar todas
      </button>
    </div>
  } @else {
    <!-- Empty state -->
    <div class="px-4 py-8 text-center" (click)="$event.stopPropagation()">
      <mat-icon class="text-gray-400 text-5xl mb-2">notifications_none</mat-icon>
      <p class="text-sm font-semibold text-gray-900 mb-1">No tienes notificaciones</p>
      <p class="text-xs text-gray-600">Te avisaremos cuando haya novedades</p>
    </div>
  }
</mat-menu>